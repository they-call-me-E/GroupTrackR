<!-- Do not edit below -->
<script type="application/json" id="tile-settings">
{
  "schema": "0.2.0",
  "settings": [
    {"name": "mToken", "label": "Mapbox Access Token", "type": "STRING"},
    {"type": "STRING", "name": "mLat", "label": "Map Zone Latitude "},
    {"type": "STRING", "name": "mLon", "label": "Map Zone Longitude "},
    {
      "name": "mZoom",
      "label": "Map Zone Zoom Level (0-22) 0 = Zoomed Out, 22 = Zoomed In",
      "type": "NUMBER"
    },
    {"type": "NUMBER", "name": "wStyle", "label": "Weather Style (0-11)"},
    {
      "type": "NUMBER",
      "name": "mStyle",
      "label": "Map Style (1: Streets, 2: Light, 3: Dark, 4: Satellite)"
    },
    {"type": "STRING", "name": "statesAlerts", "label": "NC  or NC,SC,GA,TN"}
  ],
  "name": "Rain Viewer",
  "dimensions": {"height": 3, "width": 3}
}
</script>
<!-- Do not edit above -->

<style>
    /* MAPBOX AND LAYOUT STYLES */
    .mapboxgl-ctrl-attrib.mapboxgl-compact {
        display: none !important;
    }

    .mapboxgl-ctrl {
        display: none !important;
    }

    #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
        left: 0;
        border-radius: 10px;
    }

    #animationProgress {
        position: absolute;
        left: 80px;
        bottom: 25px;
        height: 6px;
        width: calc(100% - 170px);
        background-color: #ccc;
        border-radius: 3px;
        z-index: 10;
    }

    #progressDot {
        position: absolute;
        top: 50%;
        width: 12px;
        height: 12px;
        background-color: grey;
        border-radius: 50%;
        transform: translateY(-50%);
    }

    .mapboxgl-popup-content {
        color: black;
        background-color: rgba(0, 0, 0, 0.7);
        border-radius: 6px;
        padding: 8px;
    }

    .popup-divider {
        margin: 8px 0;
        border: none;
        border-top: 1px solid #ccc;
    }

    .popup-description {
        display: none;
        max-height: 100px;
        overflow-y: auto;
        margin-top: 4px;
    }

    .popup-more-link {
        float: right;
        cursor: pointer;
        color: blue;
        text-decoration: underline;
        margin-top: 5px;
    }

    #timeDisplay {
        position: absolute;
        bottom: 10px;
        right: 10px;
        padding: 5px 10px;
        border-radius: 3px;
        font-family: Arial, sans-serif;
        font-size: 16px;
        z-index: 10;
    }

    /* FANCY PLAY/PAUSE BUTTON STYLES */
    .play,
    .play::before,
    .play::after {
        width: 100px;
        height: 100px;
        transition: 0.15s ease;
    }

    .play {
        overflow: hidden;
        position: absolute;
        bottom: -20px;
        left: 0;
        border-radius: 25px;
        transform: scale(0.25) translate(-32px, 0px) rotate(120deg) skewY(30deg) scaleX(0.866);
        transition: 0.35s cubic-bezier(0.5, 2, 0.7, 1);
    }

    .play:active {
        transform: scale(0.25) translate(-22px, 0px) rotate(120deg) skewY(30deg) scaleX(0.606) scaleY(0.7);
    }

    .play::before,
    .play::after {
        content: "";
        position: absolute;
        background: white;
        cursor: pointer;
    }

    .play::before {
        border-radius: 25px 25px 25px 50px;
        transform: scaleX(1.1555) skewY(-30deg) rotate(-30deg) translate(-24px, -42px) skewX(30deg) scaleY(0.8666);
    }

    .play::after {
        border-radius: 25px 25px 50px 25px;
        transform: scaleX(1.1555) skewY(-30deg) rotate(-30deg) translate(24px, -42px) skewX(-30deg) scaleY(0.8666);
    }

    .play.paused {
        transform: scale(0.25) translate(-7px, 0px) rotate(90deg) skewY(0deg) scaleX(1);
        cursor: pointer;
    }

    .play.paused:active {
        transform: scale(0.25) translate(-7px, 0px) rotate(90deg) skewY(0deg) scale(0.7);
    }

    .play.paused::before {
        height: 85px;
        width: 30px;
        transform: scale(1) skewY(0deg) rotate(-90deg) translate(21px, 35px) skewX(0deg);
        border-radius: 10px;
    }

    .play.paused::after {
        height: 85px;
        width: 30px;
        transform: scale(1) skewY(0deg) rotate(-90deg) translate(-21px, 35px) skewX(0deg);
        border-radius: 10px;
    }

    /* === Slide-in Menu Styles === */
    #menuButton {
        position: fixed;
        top: 10px;
        right: 10px;
        display: flex;
        align-items: center;
        z-index: 60;
        background: white;
        border: none;
        cursor: pointer;
        padding: 0px;
        border-radius: 3px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    #menuButton svg {
        width: 24px;
        height: 24px;
        fill: black;
    }

    #sideMenu {
        position: fixed;
        top: 0;
        right: 0;
        width: 250px;
        max-height: 100vh;
        background: white;
        color: black;
        box-shadow: -2px 0 5px rgba(0, 0, 0, 0.3);
        border-radius: 10px;
        transform: translateX(100%);
        transition: transform 0.3s ease;
        z-index: 50;
        padding: 20px;
        padding-bottom: 40px;
        overflow-y: auto;
        box-sizing: border-box;
    }

    #sideMenu.open {
        transform: translateX(0);
    }

    #sideMenu h3 {
        margin-top: 0;
        margin-bottom: 15px;
    }

    #sideMenu h4 {
        margin-bottom: 10px;
    }

    #sideMenu label {
        display: block;
        margin-bottom: 10px;
        font-size: 16px;
    }

    /* === Slider Styles for Opacity / Animation Speed === */
    input[type="range"] {
        -webkit-appearance: none;
        width: 100%;
        margin: 10px 0;
        position: relative;
        top: -15px;
    }

    input[type="range"]:focus {
        outline: none;
    }

    input[type="range"]::-webkit-slider-runnable-track {
        height: 6px;
        background: #ddd;
        border: none;
        border-radius: 3px;
    }

    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        height: 16px;
        width: 16px;
        border-radius: 50%;
        background: #3498db;
        margin-top: -5px;
        cursor: pointer;
    }

    .slider-labels {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: #333;
        position: relative;
        top: -42px;
        padding: 0 0px;
        left: -10px
    }

    .slider-labels span:nth-child(2) {
        margin: 0 69px;
    }

    #menuSpeed {
        position: relative;
        padding-bottom: 20px;
        top: -15px;
    }

    #menuSpeed::before {
        content: "";
        position: absolute;
        bottom: 16px;
        left: 0;
        right: 0;
        height: 15px;
        background-repeat: no-repeat;
        background-size: 1px 18px;
        background-image: linear-gradient(to right, black 1px, transparent 1px), linear-gradient(to right, black 1px, transparent 1px), linear-gradient(to right, black 1px, transparent 1px), linear-gradient(to right, black 1px, transparent 1px), linear-gradient(to right, black 1px, transparent 1px);
        background-position: 0% 0, 25% 0, 50% 0, 75% 0, 100% 0;
        pointer-events: none;
        z-index: 1;
    }

    #menuSpeed::-webkit-slider-thumb {
        position: relative;
        z-index: 2;
    }

    /* === Fly-out Panel for Alert Types === */
    #alertFlyoutBackdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.3);
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease;
        z-index: 99;
    }

    #alertFlyoutBackdrop.open {
        opacity: 1;
        visibility: visible;
    }

    #alertFlyoutPanel {
        position: fixed;
        top: 0;
        right: 0;
        width: 260px;
        height: 325px;
        border-radius: 10px;
        background: #f1f1f1;
        color: black;
        box-shadow: -2px 0 5px rgba(0, 0, 0, 0.3);
        transform: translateX(100%);
        transition: transform 0.3s ease;
        z-index: 100;
        padding: 20px 0 20px 20px;
        overflow-y: auto;
    }

    #alertFlyoutPanel.open {
        transform: translateX(0);
    }

    #alertFlyoutPanel .closeBtn {
        position: absolute;
        top: 10px;
        right: 10px;
        cursor: pointer;
        font-size: 18px;
    }

    .loader {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: block;
        margin: 15px auto;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #FFF;
        z-index: 20;
        box-sizing: border-box;
        animation: animloader 1s linear infinite alternate;
    }

    @keyframes animloader {
        0% {
            box-shadow: -38px -12px, -14px 0, 14px 0, 38px 0;
        }

        33% {
            box-shadow: -38px 0px, -14px -12px, 14px 0, 38px 0;
        }

        66% {
            box-shadow: -38px 0px, -14px 0, 14px -12px, 38px 0;
        }

        100% {
            box-shadow: -38px 0, -14px 0, 14px 0, 38px -12px;
        }
    }

    .my-geolocate-button {
        position: fixed;
        bottom: 60px;
        right: 10px;
        width: 35px;
        height: 35px;
        padding: 0;
        border-radius: 6px;
        background-color: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        cursor: pointer;
        z-index: 50;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .my-geolocate-button svg {
        width: 24px;
        height: 24px;
        color: #3498db;
    }

    .my-geolocate-button:hover {
        background-color: #eeeeee;
    }

    /* ALERT NOTIFICATION ICON + PANEL */
    #alertNotifyContainer {
        position: fixed;
        top: 10px;
        left: 10px;
        z-index: 120;
        font-family: sans-serif;
        height: 25px;
        width: 25px;
    }

    #alertNotifyIcon {
        background-color: red;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        text-align: center;
        font-weight: bold;
        cursor: pointer;
        line-height: 24px;
        font-size: 16px;
        box-shadow: 0 0 4px rgba(0, 0, 0, 0.3);
    }

    #alertNotifyPanel {
        background: white;
        color: black;
        margin-top: 8px;
        padding: 10px;
        border-radius: 6px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        width: 250px;
        max-width: 90vw;
        transform: scale(0);
        transform-origin: top left;
        transition: transform 0.3s ease, opacity 0.3s ease;
        opacity: 0;
        pointer-events: none;
    }

    #alertNotifyPanel.active {
        transform: scale(1);
        opacity: 1;
        pointer-events: auto;
    }

    .alert-headline {
        padding: 4px 0;
        border-bottom: 1px solid #ddd;
        font-size: 14px;
    }

    #forecast-layer {
        transition: opacity 0.3s ease;
    }

    #temperature-layer {
        transition: opacity 0.3s ease;
    }

    #tempLegend {
        background: rgba(255, 255, 255, 0.9);
        padding: 10px;
        border-radius: 5px;
        font-size: 12px;
    }

    #tempLegend h4 {
        margin: 0 0 5px 0;
        font-size: 14px;
    }

    #tempLegend div div {
        margin: 2px 0;
        display: flex;
        align-items: center;
    }

    #tempLegend span {
        margin-right: 5px;
    }

    .mapboxgl-popup-content {
        max-width: 300px;
        font-size: 14px;
    }

    .mapboxgl-popup-content strong {
        display: block;
        margin-bottom: 5px;
    }

    /* Inside <style>, replace existing #temperature-layer */
    #temperature-layer {
        transition: opacity 0.3s ease;
    }

    /* Inside <style>, after #alertNotifyPanel.active */
    #errorMessage {
        max-width: 80%;
        text-align: center;
        font-size: 14px;
        cursor: pointer;
    }

    #errorMessage:hover {
        background: rgba(255, 0, 0, 1);
    }
</style>

<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1,maximum-scale=1">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
<script src="//cdn.sharptools.io/js/custom-tiles.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<!-- UI Elements -->
<button id="menuButton" title="Layers">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
        <path d="M3 13h18v-2H3v2zm0 4h18v-2H3v2zm0-10v2h18V7H3z"></path>
    </svg>
</button>
<!-- Replace from <div id="sideMenu"> to </div> after alertNotifyContainer -->
<div id="sideMenu">
    <h3>Map Settings</h3>
    <label><input type="checkbox" id="menuCounties" checked> Counties</label>
    <label><input type="checkbox" id="menuArrows" checked> Arrows</label>
    <label><input type="checkbox" id="menuRadar" checked> Radar Layer</label>
    <label><input type="checkbox" id="menuTemperature"> Temperature Overlay</label>
    <label for="menuTempOpacity">Temperature Opacity</label>
    <input type="range" id="menuTempOpacity" min="0" max="1" step="0.1" value="0.6">
    <div id="tempLegend" style="display: none; margin-top: 10px;">
        <h4>Temperature (°F)</h4>
        <div style="display: flex; flex-direction: column;">
            <div><span style="display: inline-block; width: 20px; height: 10px; background: #0000ff;"></span>
                < 32</div>
                    <div><span style="display: inline-block; width: 20px; height: 10px; background: #00ffff;"></span>
                        32–50</div>
                    <div><span style="display: inline-block; width: 20px; height: 10px; background: #00ff00;"></span>
                        50–65</div>
                    <div><span style="display: inline-block; width: 20px; height: 10px; background: #ffff00;"></span>
                        65–80</div>
                    <div><span style="display: inline-block; width: 20px; height: 10px; background: #ff8000;"></span>
                        80–95</div>
                    <div><span style="display: inline-block; width: 20px; height: 10px; background: #ff0000;"></span> >
                        95</div>
            </div>
        </div>
        <label><input type="checkbox" id="menuContours" checked> Contours</label>
        <label for="menuContourOpacity">Contour Opacity</label>
        <input type="range" id="menuContourOpacity" min="0" max="1" step="0.1" value="0.8">
        <label><input type="checkbox" id="menuAlerts" checked> Alerts
            <button id="alertFlyoutBtn" title="..." style="font-size:14px; margin-left:5px;">Alert Types</button>
        </label>
        <label for="menuOpacity">Radar Opacity</label>
        <input type="range" id="menuOpacity" min="0" max="1" step="0.1" value="1">
        <label for="menuSpeed">Animation Speed</label>
        <input type="range" id="menuSpeed" min="1" max="5" step="1" value="3">
        <div class="slider-labels">
            <span class="slow">Slow</span>
            <span class="medium">Medium</span>
            <span class="fast">Fast</span>
        </div>
    </div>
    <div id="alertFlyoutBackdrop"></div>
    <div id="alertFlyoutPanel">
        <span class="closeBtn" id="alertFlyoutClose">X</span>
        <h4>Alert Types</h4>
        <div id="flyoutAlertFilters"></div>
    </div>
    <div id="map"></div>
    <span class="loader" id="spinner" style="display:block;"></span>
    <div class="play" id="playPauseBtn"></div>
    <div id="timeDisplay"></div>
    <div id="animationProgress">
        <div id="progressDot"></div>
    </div>
    <div id="myGeolocateButton" class="my-geolocate-button" title="Go to My Location">
        <svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
            <path fill="currentColor"
                d="M10 4C9 4 9 5 9 5L9 5.1A5 5 0 0 0 5.1 9L5 9C5 9 4 9 4 10 4 11 5 11 5 11L5.1 11A5 5 0 0 0 9 14.9L9 15C9 15 9 16 10 16 11 16 11 15 11 15L11 14.9A5 5 0 0 0 14.9 11L15 11C15 11 16 11 16 10 16 9 15 9 15 9L14.9 9A5 5 0 0 0 11 5.1L11 5C11 5 11 4 10 4zM10 6.5A3.5 3.5 0 0 1 13.5 10 3.5 3.5 0 0 1 10 13.5 3.5 3.5 0 0 1 6.5 10 3.5 3.5 0 0 1 10 6.5zM10 8.3A1.8 1.8 0 0 0 8.3 10 1.8 1.8 0 0 0 10 11.8 1.8 1.8 0 0 0 11.8 10 1.8 1.8 0 0 0 10 8.3z">
            </path>
        </svg>
    </div>
    <div id="alertNotifyContainer" style="display:none;">
        <div id="alertNotifyIcon">i</div>
        <div id="alertNotifyPanel"></div>
    </div>
    <div id="errorMessage"
        style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(255,0,0,0.8); color:white; padding:10px; border-radius:5px; z-index:1000;">
    </div>
    <script>
        // === Constants ===
        const ALERT_COLORS = {
            'Tornado Warning': '#ff0000',
            'Severe Thunderstorm Warning': '#ffa500',
            'Flood Warning': '#008000',
            'Special Weather Statement': '#800080',
            'default': '#808080'
        };
        const STATE_ABBR = {
            'AL': 'Alabama',
            'AK': 'Alaska',
            'AZ': 'Arizona',
            'AR': 'Arkansas',
            'CA': 'California',
            'CO': 'Colorado',
            'CT': 'Connecticut',
            'DE': 'Delaware',
            'FL': 'Florida',
            'GA': 'Georgia',
            'HI': 'Hawaii',
            'ID': 'Idaho',
            'IL': 'Illinois',
            'IN': 'Indiana',
            'IA': 'Iowa',
            'KS': 'Kansas',
            'KY': 'Kentucky',
            'LA': 'Louisiana',
            'ME': 'Maine',
            'MD': 'Maryland',
            'MA': 'Massachusetts',
            'MI': 'Michigan',
            'MN': 'Minnesota',
            'MS': 'Mississippi',
            'MO': 'Missouri',
            'MT': 'Montana',
            'NE': 'Nebraska',
            'NV': 'Nevada',
            'NH': 'New Hampshire',
            'NJ': 'New Jersey',
            'NM': 'New Mexico',
            'NY': 'New York',
            'NC': 'North Carolina',
            'ND': 'North Dakota',
            'OH': 'Ohio',
            'OK': 'Oklahoma',
            'OR': 'Oregon',
            'PA': 'Pennsylvania',
            'RI': 'Rhode Island',
            'SC': 'South Carolina',
            'SD': 'South Dakota',
            'TN': 'Tennessee',
            'TX': 'Texas',
            'UT': 'Utah',
            'VT': 'Vermont',
            'VA': 'Virginia',
            'WA': 'Washington',
            'WV': 'West Virginia',
            'WI': 'Wisconsin',
            'WY': 'Wyoming'
        };
        const CONSTANTS = {
            OPENWEATHER_API_KEY: '1477cbdbd942d01b6e5b4eb630731226',
            METEOBLUE_API_KEY: 'rSFga0DY1WXqdMeQ', // Secure in production
            FADE_DURATION_MS: 150,
            INITIAL_FADE_MS: 600,
            END_OF_LOOP_PAUSE_MS: 2000,
            DEBOUNCE_MS: 300
        };

        // === App State ===
        const AppState = {
            map: null,
            marker: null,
            radar: {
                frames: [],
                currentIndex: 0,
                activeBuffer: 'A',
                isPlaying: false,
                interval: null,
                animationIntervalMS: 1500,
                opacity: 1
            },
            alerts: {
                filters: {},
                active: []
            },
            settings: {
                lat: 35,
                lon: -83,
                zoom: 5,
                token: null,
                wStyle: 1,
                mStyle: 'mapbox://styles/mapbox/dark-v11',
                stateAlerts: 'NC',
                showCounties: true,
                showAlerts: true,
                showArrows: false,
                showRadar: true,
                autoPlay: true,
                showContours: true,
                tempOpacity: 0.6
            }
        };

        // Initialize alert filters
        Object.keys(ALERT_COLORS).forEach(key => {
            if (key !== 'default') AppState.alerts.filters[key] = true;
        });

        // === Utility Functions ===
        const Utils = {
            debounce: (func, wait) => {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func(...args), wait);
                };
            },
            showError: (message, duration = 5000) => {
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                errorDiv.onclick = () => errorDiv.style.display = 'none';
                if (duration) setTimeout(() => errorDiv.style.display = 'none', duration);
            }
        };

        // === Map Manager ===
        const MapManager = {
            initialize: async () => {
                if (!AppState.settings.token) {
                    Utils.showError('Mapbox token missing. Please check settings.');
                    return;
                }
                if (isNaN(AppState.settings.lat) || isNaN(AppState.settings.lon)) {
                    Utils.showError('Invalid latitude/longitude. Using defaults.');
                    AppState.settings.lat = 35;
                    AppState.settings.lon = -83;
                }

                mapboxgl.accessToken = AppState.settings.token;
                try {
                    AppState.map = new mapboxgl.Map({
                        container: 'map',
                        style: AppState.settings.mStyle,
                        center: [AppState.settings.lon, AppState.settings.lat],
                        zoom: AppState.settings.zoom
                    });
                } catch (err) {
                    Utils.showError('Failed to initialize map: ' + err.message);
                    return;
                }

                AppState.map.dragRotate.disable();
                AppState.map.touchZoomRotate.disableRotation();

                AppState.marker = new mapboxgl.Marker()
                    .setLngLat([AppState.settings.lon, AppState.settings.lat])
                    .addTo(AppState.map);

                AppState.marker.getElement().style.cursor = 'pointer';
                AppState.marker.getElement().addEventListener('click', () => ForecastManager.showPopup(AppState.marker.getLngLat()));

                AppState.map.on('styleimagemissing', (e) => {
                    if (e.id === 'arrow-icon') {
                        const arrowUrl = 'https://raw.githubusercontent.com/they-call-me-E/Sharptools/main/CustomeTile/RainViewer/arrow1.png';
                        AppState.map.loadImage(arrowUrl, (err, image) => {
                            if (err) return console.error('Error loading arrow icon:', err);
                            if (!AppState.map.hasImage('arrow-icon')) AppState.map.addImage('arrow-icon', image);
                        });
                    }
                });

                AppState.map.on('moveend', Utils.debounce(() => {
                    const closestAbbrs = MapManager.getClosestStateAbbreviations(4);
                    AppState.settings.stateAlerts = closestAbbrs.join(',');
                    if (AppState.settings.showAlerts) AlertManager.fetchAlerts();
                }, CONSTANTS.DEBOUNCE_MS));

                AppState.map.on('load', async () => {
                    try {
                        await MapManager.addStatesLayer();
                        if (AppState.settings.showCounties) await MapManager.addCountiesLayer();

                        // Add terrain contour lines
                        if (!AppState.map.getSource('terrain-data')) {
                            AppState.map.addSource('terrain-data', {
                                type: 'vector',
                                url: 'mapbox://mapbox.mapbox-terrain-v2'
                            });
                        }
                        if (!AppState.map.getLayer('contour-lines')) {
                            AppState.map.addLayer({
                                id: 'contour-lines',
                                type: 'line',
                                source: 'terrain-data',
                                'source-layer': 'contour',
                                layout: {
                                    visibility: AppState.settings.showContours ? 'visible' : 'none'
                                },
                                paint: {
                                    'line-color': '#888888',
                                    'line-width': [
                                        'interpolate', ['linear'], ['zoom'],
                                        5, 0.5,
                                        12, 1.5
                                    ],
                                    'line-opacity': [
                                        'interpolate', ['linear'], ['zoom'],
                                        5, 0.3,
                                        12, 0.7
                                    ]
                                }
                            });
                        }

                        await RadarManager.fetchData();
                        await AlertManager.fetchAlerts();

                        RadarManager.preloadFrames(() => {
                            document.getElementById('spinner').style.display = 'none';
                            RadarManager.setupBuffers();
                            AppState.map.once('idle', () => {
                                RadarManager.fadeLayerIn('radarLayerA', CONSTANTS.INITIAL_FADE_MS);
                                RadarManager.updateTimeDisplay(AppState.radar.currentIndex);
                            });
                            if (AppState.settings.autoPlay) RadarManager.animate();
                            else document.getElementById('playPauseBtn').classList.add('paused');
                        });

                        const arrowUrl = 'https://raw.githubusercontent.com/they-call-me-E/Sharptools/main/CustomeTile/RainViewer/arrow1.png';
                        AppState.map.loadImage(arrowUrl, (err, image) => {
                            if (err) return console.error('Error loading arrow icon:', err);
                            if (!AppState.map.hasImage('arrow-icon')) AppState.map.addImage('arrow-icon', image);
                        });

                        AppState.map.on('click', ForecastManager.showTemperaturePopup);
                        if (document.getElementById('menuTemperature').checked) MapManager.addTemperatureLayer();
                    } catch (err) {
                        Utils.showError('Map load failed: ' + err.message);
                    }
                });

                AppState.map.on('error', (e) => {
                    Utils.showError('Map error: ' + e.error.message);
                });
            },
            addStatesLayer: async () => {
                // Stub: Fetch and add states GeoJSON (unchanged logic)
                if (!AppState.map.getSource('states')) {
                    AppState.map.addSource('states', {
                        type: 'geojson',
                        data: 'https://raw.githubusercontent.com/they-call-me-E/Sharptools/main/CustomeTile/RainViewer/states.geojson'
                    });
                    AppState.map.addLayer({
                        id: 'states-layer',
                        type: 'line',
                        source: 'states',
                        paint: {
                            'line-color': '#ffffff',
                            'line-width': 1
                        }
                    });
                }
            },
            addCountiesLayer: async () => {
                // Stub: Fetch and add counties GeoJSON (unchanged logic)
                if (!AppState.map.getSource('counties')) {
                    AppState.map.addSource('counties', {
                        type: 'geojson',
                        data: 'https://raw.githubusercontent.com/they-call-me-E/Sharptools/main/CustomeTile/RainViewer/counties.geojson'
                    });
                    AppState.map.addLayer({
                        id: 'counties-layer',
                        type: 'line',
                        source: 'counties',
                        paint: {
                            'line-color': '#cccccc',
                            'line-width': 0.5
                        }
                    });
                }
            },
            addTemperatureLayer: () => {
                if (!AppState.map.getSource('temperature')) {
                    AppState.map.addSource('temperature', {
                        type: 'raster',
                        tiles: [
                            `https://maps-api.meteoblue.com/v1/map/tile/temperature/{z}/{x}/{y}?apikey=${CONSTANTS.METEOBLUE_API_KEY}`
                        ],
                        tileSize: 256,
                        minzoom: 0,
                        maxzoom: 12
                    });
                    AppState.map.addLayer({
                        id: 'temperature-layer',
                        type: 'raster',
                        source: 'temperature',
                        paint: {
                            'raster-opacity': AppState.settings.tempOpacity
                        }
                    }, 'radarLayerA');
                    document.getElementById('tempLegend').style.display = 'block';
                }
            },
            getClosestStateAbbreviations: (numStates = 3) => {
                // Stub: Calculate closest states (unchanged logic)
                return ['NC', 'SC', 'GA'].slice(0, numStates);
            }
        };

        // === Radar Manager ===
        const RadarManager = {
            fetchData: async () => {
                // Stub: Fetch RainViewer data
                try {
                    const response = await fetch('https://api.rainviewer.com/public/weather-maps.json');
                    if (!response.ok) throw new Error('Failed to fetch radar data');
                    const data = await response.json();
                    AppState.radar.frames = data.radar.past.map(frame => frame.path);
                } catch (err) {
                    Utils.showError('Radar data fetch failed: ' + err.message);
                    AppState.radar.frames = [];
                }
            },
            preloadFrames: (onComplete) => {
                // Stub: Preload radar frames
                if (AppState.radar.frames.length) {
                    const img = new Image();
                    img.onload = onComplete;
                    img.src = AppState.radar.frames[0];
                } else {
                    onComplete();
                }
            },
            setupBuffers: () => {
                // Stub: Setup radar layers A/B
                if (AppState.radar.frames.length && !AppState.map.getSource('radarSourceA')) {
                    RadarManager.createLayer('radarSourceA', 'radarLayerA', AppState.radar.frames[0], AppState.radar.opacity);
                    RadarManager.createLayer('radarSourceB', 'radarLayerB', AppState.radar.frames[0], 0);
                }
            },
            createLayer: (sourceId, layerId, tileUrl, initOpacity) => {
                if (!AppState.map.getSource(sourceId)) {
                    AppState.map.addSource(sourceId, {
                        type: 'raster',
                        tiles: [tileUrl],
                        tileSize: 256
                    });
                    AppState.map.addLayer({
                        id: layerId,
                        type: 'raster',
                        source: sourceId,
                        paint: {
                            'raster-opacity': initOpacity
                        }
                    }, 'states-layer');
                }
            },
            fadeLayerIn: (layerId, durationMs) => {
                // Stub: Fade in layer
                AppState.map.setPaintProperty(layerId, 'raster-opacity', AppState.radar.opacity);
            },
            animate: () => {
                // Stub: Animate radar
                if (!AppState.radar.isPlaying) {
                    AppState.radar.isPlaying = true;
                    AppState.radar.interval = setInterval(() => {
                        RadarManager.crossfadeNextFrame();
                    }, AppState.radar.animationIntervalMS);
                }
            },
            crossfadeNextFrame: () => {
                const oldBuf = AppState.radar.activeBuffer;
                const newBuf = oldBuf === 'A' ? 'B' : 'A';
                const oldLayerId = `radarLayer${oldBuf}`;
                const newLayerId = `radarLayer${newBuf}`;
                const newSourceId = `radarSource${newBuf}`;
                AppState.radar.currentIndex = (AppState.radar.currentIndex + 1) % AppState.radar.frames.length;
                const frameUrl = AppState.radar.frames[AppState.radar.currentIndex];
                if (AppState.map.getSource(newSourceId)) {
                    AppState.map.removeLayer(newLayerId);
                    AppState.map.removeSource(newSourceId);
                }
                RadarManager.createLayer(newSourceId, newLayerId, frameUrl, 0);
                AppState.map.once('idle', () => RadarManager.fadeLayers(oldLayerId, newLayerId, CONSTANTS.FADE_DURATION_MS));
                AppState.radar.activeBuffer = newBuf;
                RadarManager.updateProgressBar(AppState.radar.currentIndex);
                RadarManager.updateTimeDisplay(AppState.radar.currentIndex);
            },
            fadeLayers: (layerOut, layerIn, durationMs) => {
                // Stub: Crossfade layers
                AppState.map.setPaintProperty(layerIn, 'raster-opacity', AppState.radar.opacity);
                AppState.map.setPaintProperty(layerOut, 'raster-opacity', 0);
            },
            updateProgressBar: (frameIndex) => {
                // Stub: Update progress dot
                const progress = (frameIndex / (AppState.radar.frames.length - 1)) * 100;
                document.getElementById('progressDot').style.left = `${progress}%`;
            },
            updateTimeDisplay: (frameIndex) => {
                // Stub: Update time display
                const time = new Date(Date.now() - (AppState.radar.frames.length - frameIndex - 1) * 10 * 60 * 1000);
                document.getElementById('timeDisplay').textContent = time.toLocaleTimeString();
            },
            computeAndDisplayArrows: () => {
                // Empty: Deprecated
            }
        };

        // === Alert Manager ===
        const AlertManager = {
            fetchAlerts: async () => {
                // Stub: Fetch NOAA alerts
                try {
                    const response = await fetch(`https://api.weather.gov/alerts/active?area=${AppState.settings.stateAlerts}`);
                    if (!response.ok) throw new Error('Failed to fetch alerts');
                    const data = await response.json();
                    AppState.alerts.active = data.features || [];
                } catch (err) {
                    Utils.showError('Alerts fetch failed: ' + err.message);
                    AppState.alerts.active = [];
                }
            },
            removeAllLayers: () => {
                // Stub: Remove alert layers
                AppState.alerts.active.forEach(alert => {
                    const layerId = `alert-layer-${alert.id}`;
                    if (AppState.map.getLayer(layerId)) AppState.map.removeLayer(layerId);
                    if (AppState.map.getSource(layerId)) AppState.map.removeSource(layerId);
                });
            }
        };

        // === Forecast Manager ===
        const ForecastManager = {
            getGridpoint: async (lat, lon) => {
                // Stub: Fetch NWS gridpoint
                try {
                    const response = await fetch(`https://api.weather.gov/points/${lat},${lon}`);
                    if (!response.ok) throw new Error('Failed to fetch gridpoint');
                    const data = await response.json();
                    return data.properties.forecast;
                } catch (err) {
                    console.error('Error fetching gridpoint:', err);
                    return null;
                }
            },
            getTemperature: async (lat, lon) => {
                try {
                    const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${CONSTANTS.OPENWEATHER_API_KEY}&units=imperial`);
                    if (!response.ok) throw new Error('Failed to fetch temperature');
                    const data = await response.json();
                    return {
                        temp: data.main.temp,
                        feelsLike: data.main.feels_like,
                        description: data.weather[0].description
                    };
                } catch (err) {
                    console.error('Error fetching temperature:', err);
                    Utils.showError('Temperature data unavailable');
                    return null;
                }
            },
            showPopup: async (coords) => {
                // Stub: Show forecast popup
                const forecastUrl = await ForecastManager.getGridpoint(coords.lat, coords.lng);
                if (forecastUrl) {
                    try {
                        const response = await fetch(forecastUrl);
                        if (!response.ok) throw new Error('Failed to fetch forecast');
                        const data = await response.json();
                        new mapboxgl.Popup()
                            .setLngLat(coords)
                            .setHTML(`<strong>Forecast</strong><br>${data.properties.periods[0].detailedForecast}`)
                            .addTo(AppState.map);
                    } catch (err) {
                        Utils.showError('Forecast unavailable');
                    }
                }
            },
            showTemperaturePopup: async (e) => {
                if (!document.getElementById('menuTemperature').checked) return;
                const tempData = await ForecastManager.getTemperature(e.lngLat.lat, e.lngLat.lng);
                if (tempData) {
                    new mapboxgl.Popup()
                        .setLngLat(e.lngLat)
                        .setHTML(`<strong>Temperature: ${tempData.temp.toFixed(1)}°F</strong><br>Feels Like: ${tempData.feelsLike.toFixed(1)}°F<br>${tempData.description}`)
                        .addTo(AppState.map);
                }
            }
        };

        // === UI Handlers ===
        const UIHandlers = {
            init: () => {
                document.getElementById('menuContours').addEventListener('change', (e) => {
                    AppState.settings.showContours = e.target.checked;
                    const visibility = e.target.checked ? 'visible' : 'none';
                    if (AppState.map.getLayer('contour-lines')) {
                        AppState.map.setLayoutProperty('contour-lines', 'visibility', visibility);
                    }
                });
                document.getElementById('menuContourOpacity').addEventListener('input', (e) => {
                    const opacity = parseFloat(e.target.value);
                    if (AppState.map.getLayer('contour-lines')) {
                        AppState.map.setPaintProperty('contour-lines', 'line-opacity', opacity);
                    }
                });
                document.getElementById('menuTemperature').addEventListener('change', (e) => {
                    const visibility = e.target.checked ? 'visible' : 'none';
                    const legend = document.getElementById('tempLegend');
                    if (e.target.checked) {
                        if (!AppState.map.getLayer('temperature-layer')) MapManager.addTemperatureLayer();
                        if (AppState.map.getLayer('temperature-layer')) {
                            AppState.map.setLayoutProperty('temperature-layer', 'visibility', visibility);
                            AppState.map.setPaintProperty('temperature-layer', 'raster-opacity', AppState.settings.tempOpacity);
                        }
                        legend.style.display = 'block';
                    } else {
                        if (AppState.map.getLayer('temperature-layer')) {
                            AppState.map.setLayoutProperty('temperature-layer', 'visibility', visibility);
                        }
                        legend.style.display = 'none';
                    }
                });
                document.getElementById('menuTempOpacity').addEventListener('input', (e) => {
                    AppState.settings.tempOpacity = parseFloat(e.target.value);
                    if (AppState.map.getLayer('temperature-layer')) {
                        AppState.map.setPaintProperty('temperature-layer', 'raster-opacity', AppState.settings.tempOpacity);
                    }
                });
                document.getElementById('menuButton').addEventListener('click', () => document.getElementById('sideMenu').classList.toggle('open'));
                document.getElementById('myGeolocateButton').addEventListener('click', () => AppState.map.flyTo({ center: [AppState.settings.lon, AppState.settings.lat], zoom: AppState.settings.zoom }));
                document.getElementById('playPauseBtn').addEventListener('click', () => {
                    if (document.getElementById('playPauseBtn').classList.contains('paused')) {
                        document.getElementById('playPauseBtn').classList.remove('paused');
                        AppState.radar.isPlaying = false;
                        if (AppState.radar.interval) clearInterval(AppState.radar.interval);
                        AppState.radar.interval = null;
                    } else {
                        document.getElementById('playPauseBtn').classList.add('paused');
                        AppState.radar.isPlaying = true;
                        if (!AppState.radar.interval) RadarManager.animate();
                    }
                });
                document.getElementById('menuCounties').addEventListener('change', (e) => {
                    AppState.settings.showCounties = e.target.checked;
                    if (AppState.settings.showCounties) MapManager.addCountiesLayer();
                    else {
                        if (AppState.map.getLayer('counties-layer')) AppState.map.removeLayer('counties-layer');
                        if (AppState.map.getSource('counties')) AppState.map.removeSource('counties');
                    }
                });
                document.getElementById('menuArrows').addEventListener('change', (e) => {
                    AppState.settings.showArrows = e.target.checked;
                    if (AppState.map.getLayer('arrowLayer')) AppState.map.setLayoutProperty('arrowLayer', 'visibility', AppState.settings.showArrows ? 'visible' : 'none');
                });
                document.getElementById('menuRadar').addEventListener('change', (e) => {
                    AppState.settings.showRadar = e.target.checked;
                    if (!AppState.settings.showRadar) {
                        if (AppState.radar.interval) clearInterval(AppState.radar.interval);
                        AppState.radar.interval = null;
                        if (AppState.map.getLayer('radarLayerA')) AppState.map.setLayoutProperty('radarLayerA', 'visibility', 'none');
                        if (AppState.map.getLayer('radarLayerB')) AppState.map.setLayoutProperty('radarLayerB', 'visibility', 'none');
                    } else {
                        if (AppState.map.getLayer('radarLayerA')) AppState.map.setLayoutProperty('radarLayerA', 'visibility', 'visible');
                        if (AppState.map.getLayer('radarLayerB')) AppState.map.setLayoutProperty('radarLayerB', 'visibility', 'visible');
                        if (!AppState.radar.interval && AppState.radar.isPlaying) RadarManager.animate();
                    }
                });
                document.getElementById('menuOpacity').addEventListener('input', (e) => {
                    AppState.radar.opacity = Math.max(0, Math.min(1, parseFloat(e.target.value)));
                    if (AppState.map.getLayer('radarLayerA')) AppState.map.setPaintProperty('radarLayerA', 'raster-opacity', AppState.radar.opacity);
                    if (AppState.map.getLayer('radarLayerB')) AppState.map.setPaintProperty('radarLayerB', 'raster-opacity', AppState.radar.opacity);
                });
                document.getElementById('menuSpeed').addEventListener('input', (e) => {
                    const stepValue = parseInt(e.target.value, 10);
                    AppState.radar.animationIntervalMS = [2500, 2000, 1500, 1000, 500][stepValue - 1];
                    if (AppState.radar.interval) {
                        clearInterval(AppState.radar.interval);
                        if (AppState.radar.isPlaying) RadarManager.animate();
                    }
                });
                document.getElementById('menuAlerts').addEventListener('change', (e) => {
                    AppState.settings.showAlerts = e.target.checked;
                    if (!AppState.settings.showAlerts) AlertManager.removeAllLayers();
                    else AlertManager.fetchAlerts();
                });
                document.getElementById('alertFlyoutBtn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.getElementById('alertFlyoutBackdrop').classList.add('open');
                    document.getElementById('alertFlyoutPanel').classList.add('open');
                    const container = document.getElementById('flyoutAlertFilters');
                    container.innerHTML = '';
                    Object.keys(AppState.alerts.filters).forEach(alertType => {
                        const label = document.createElement('label');
                        label.style.cssText = 'display: block; margin-bottom: 8px; font-size: 14px; vertical-align: middle;';
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.checked = AppState.alerts.filters[alertType];
                        checkbox.setAttribute('data-type', alertType);
                        checkbox.style.verticalAlign = 'middle';
                        checkbox.addEventListener('change', (e) => {
                            AppState.alerts.filters[e.target.getAttribute('data-type')] = e.target.checked;
                            AlertManager.removeAllLayers();
                            if (AppState.settings.showAlerts) AlertManager.fetchAlerts();
                        });
                        label.appendChild(checkbox);
                        const colorBox = document.createElement('span');
                        colorBox.style.cssText = `width: 16px; height: 16px; display: inline-block; background-color: ${ALERT_COLORS[alertType] || 'transparent'}; margin: 0 5px; vertical-align: middle;`;
                        label.appendChild(colorBox);
                        label.appendChild(document.createTextNode(alertType));
                        container.appendChild(label);
                    });
                });
                document.getElementById('alertFlyoutClose').addEventListener('click', () => {
                    document.getElementById('alertFlyoutBackdrop').classList.remove('open');
                    document.getElementById('alertFlyoutPanel').classList.remove('open');
                });
                document.getElementById('alertFlyoutBackdrop').addEventListener('click', () => {
                    document.getElementById('alertFlyoutBackdrop').classList.remove('open');
                    document.getElementById('alertFlyoutPanel').classList.remove('open');
                });
                document.getElementById('alertNotifyIcon').addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.getElementById('alertNotifyPanel').classList.toggle('active');
                });
                document.addEventListener('click', (e) => {
                    const sideMenu = document.getElementById('sideMenu');
                    const menuButton = document.getElementById('menuButton');
                    const alertPanel = document.getElementById('alertNotifyPanel');
                    const alertIcon = document.getElementById('alertNotifyIcon');
                    const flyoutPanel = document.getElementById('alertFlyoutPanel');
                    if (sideMenu.classList.contains('open') && !sideMenu.contains(e.target) && !menuButton.contains(e.target)) {
                        sideMenu.classList.remove('open');
                    }
                    if (alertPanel.classList.contains('active') && !alertPanel.contains(e.target) && !alertIcon.contains(e.target)) {
                        alertPanel.classList.remove('active');
                    }
                    if (flyoutPanel.classList.contains('open') && !flyoutPanel.contains(e.target) && e.target.id !== 'alertFlyoutBtn') {
                        flyoutPanel.classList.remove('open');
                        document.getElementById('alertFlyoutBackdrop').classList.remove('open');
                    }
                });
            }
        };

        // === Initialization ===
        const init = async () => {
            await stio.ready((data) => {
                if (data.settings.mToken) {
                    AppState.settings.token = data.settings.mToken;
                    AppState.settings.lat = typeof data.settings.mLat === 'string' ? parseFloat(data.settings.mLat) : AppState.settings.lat;
                    AppState.settings.lon = typeof data.settings.mLon === 'string' ? parseFloat(data.settings.mLon) : AppState.settings.lon;
                    AppState.settings.zoom = data.settings.mZoom || AppState.settings.zoom;
                    AppState.settings.wStyle = data.settings.wStyle || AppState.settings.wStyle;
                    AppState.settings.stateAlerts = data.settings.statesAlerts || AppState.settings.stateAlerts;
                    AppState.settings.mStyle = {
                        1: 'mapbox://styles/mapbox/streets-v12',
                        2: 'mapbox://styles/mapbox/light-v11',
                        3: 'mapbox://styles/mapbox/dark-v11',
                        4: 'mapbox://styles/mapbox/satellite-v9'
                    }[data.settings.mStyle] || AppState.settings.mStyle;

                    document.getElementById('menuAlerts').checked = AppState.settings.showAlerts;
                    document.getElementById('menuCounties').checked = AppState.settings.showCounties;
                    document.getElementById('menuArrows').checked = AppState.settings.showArrows;
                    document.getElementById('menuContours').checked = AppState.settings.showContours;
                    document.getElementById('menuTemperature').checked = false;
                    MapManager.initialize();
                    UIHandlers.init();
                } else {
                    Utils.showError('SharpTools settings incomplete. Please configure Mapbox token.');
                }
            });
        };

        init();
    </script>