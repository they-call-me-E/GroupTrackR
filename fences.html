<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Full-Screen Map with Geofence and Auto GPS Update</title>

  <!-- Mapbox GL JS and CSS -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet" />

  <style>
    /* Ensure the body and HTML take up the full viewport */
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      color: #ffffff;
      font-family: "Poppins", sans-serif;
    }

    /* Fullscreen container for the map and controls */
    .container {
      display: flex;
      flex-direction: row;
      height: 100%;
      width: 100%;
    }

    .left {
      width: 30%;
      background-color: #07101d;
      padding: 10px;
      box-sizing: border-box;
    }

    .right {
      width: 70%;
      position: relative;
      height: 100%;
    }

    /* Fullscreen map */
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      height: 100%;
      width: 100%;
    }

    /* Input fields styling */
    label {
      display: block;
      margin-bottom: 5px;
    }

    form {
      color: #FFFFFF;
      background-color: #07101d;
    }

    input {
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
      box-sizing: border-box;
      border-radius: 8px;
    }

    button {
      padding: 10px;
      width: 100%;
      background-color: #47e9ff;
      color: #080d2b;
      border: none;
      cursor: pointer;
      margin-top: 10px;
      border-radius: 8px;
      font-weight: bolder;
    }

    button:disabled,
    button[disabled] {
      border: 1px solid black;
      background-color: grey;
      color: white;
      padding: 15px;
      cursor: not-allowed;
    }

    /* button:hover {
      background-color: #0056b3;
    } */

    /* Styling for slider and radius display */
    .slider-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .slider-container input[type=range] {
      width: 70%;
    }

    .radius-display {
      font-size: 16px;
      font-weight: bold;
    }

    .mapboxgl-ctrl-attrib.mapboxgl-compact {
      display: none;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="left">
      <h3 id="geofenceHeading">Geofence Settings</h3>
      <form id="infoForm">
        <label for="name">Name:</label>
        <input type="text" id="name" name="name" placeholder="Enter name">

        <label for="address">Address:</label>
        <input type="text" id="address" name="address"
          placeholder="Enter full address (e.g., 287 Castleton Cir, Boiling Springs, SC, USA)">

        <label for="lat">Latitude:</label>
        <input type="text" id="lat" name="lat" placeholder="Enter latitude" readonly>

        <label for="lon">Longitude:</label>
        <input type="text" id="lon" name="lon" placeholder="Enter longitude" readonly>

        <label>Geofence Radius</label>
        <div class="slider-container">
          <input type="range" id="radiusSlider" min="100" max="1000" value="250">
          <span class="radius-display" id="radiusDisplay">250 ft</span>
        </div>

        <button type="button" id="saveFenceData" class="savebtn">Save Location</button>
        <button type="button" id="deleteFenceData" class="deletebtn">Delete Place</button>
        <!-- New Button to convert address to GPS coordinates and move the map -->
        <!-- <button type="button" id="addressToCoordinates">Move Map to Address</button> -->

      </form>
    </div>
    <div class="right">
      <!-- Map will render here -->
      <div id="map"></div>
    </div>
  </div>

<script>
  const token = sessionStorage.getItem('token');
  if (!token) {
    window.location.href = 'Auth/login.html';
  }

  mapboxgl.accessToken = 'pk.eyJ1IjoidGhleWNhbGxtZWUiLCJhIjoiY2xhZXF6anQxMHgzazNxczNzd2I5em10dyJ9.fa-pBQ_2cMg9H2fD-FBCDg';
  let groupUUID = null;
  let fenceUUID = null;
  let isCreate = false;

  window.onload = function () {
    const urlParams = new URLSearchParams(window.location.search);
    isCreate = urlParams.get('create') === 'true';
    fenceUUID = urlParams.get('fenceUUID');
    const fenceName = urlParams.get('name') || '';
    const fenceRadius = urlParams.get('radius') || '250';
    const fenceLat = urlParams.get('lat');
    const fenceLon = urlParams.get('lon');
    groupUUID = urlParams.get('groupid');

    const fenceLatNum = parseFloat(fenceLat);
    const fenceLonNum = parseFloat(fenceLon);
    let radiusInFeet = parseInt(fenceRadius);

    if (isCreate) {
      document.getElementById('deleteFenceData').disabled = true;
      document.getElementById('geofenceHeading').innerText = 'Create New Geofence';
      document.getElementById('saveFenceData').innerText = 'Create Location';
    }

    if (fenceLat && fenceLon) {
      document.getElementById('name').value = fenceName;
      document.getElementById('radiusSlider').value = radiusInFeet;
      document.getElementById('radiusDisplay').innerText = `${radiusInFeet} ft`;
      document.getElementById('lat').value = fenceLat;
      document.getElementById('lon').value = fenceLon;

      const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/dark-v10',
        center: [fenceLonNum, fenceLatNum],
        zoom: 16
      });

      map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');

      const marker = new mapboxgl.Marker({ draggable: false })
        .setLngLat([fenceLonNum, fenceLatNum])
        .addTo(map);

      map.on('load', function () {
        map.addSource('geofence', {
          type: 'geojson',
          data: createGeoJSONCircle([fenceLonNum, fenceLatNum], radiusInFeet)
        });

        map.addLayer({
          id: 'geofence-layer',
          type: 'fill',
          source: 'geofence',
          paint: {
            'fill-color': '#007bff',
            'fill-opacity': 0.3
          }
        });
      });

      map.on('move', function () {
        const center = map.getCenter();
        marker.setLngLat(center);
        map.getSource('geofence').setData(createGeoJSONCircle([center.lng, center.lat], radiusInFeet));
      });

      map.on('moveend', function () {
        const center = map.getCenter();
        const lat = center.lat.toFixed(6);
        const lon = center.lng.toFixed(6);

        document.getElementById('lat').value = lat;
        document.getElementById('lon').value = lon;

        const reverseGeocodeURL = `https://api.mapbox.com/geocoding/v5/mapbox.places/${lon},${lat}.json?access_token=${mapboxgl.accessToken}`;
        fetch(reverseGeocodeURL)
          .then(response => response.json())
          .then(data => {
            document.getElementById('address').value = data.features?.[0]?.place_name || "Address not found.";
          })
          .catch(() => {
            document.getElementById('address').value = "Error retrieving address.";
          });
      });

      document.getElementById('radiusSlider').addEventListener('input', function () {
        radiusInFeet = parseInt(this.value);
        document.getElementById('radiusDisplay').innerText = `${radiusInFeet} ft`;
        const center = map.getCenter();
        map.getSource('geofence').setData(createGeoJSONCircle([center.lng, center.lat], radiusInFeet));
      });
    }
  };

  function createGeoJSONCircle(center, radiusInFeet) {
    const radiusInMeters = radiusInFeet * 0.3048;
    const points = 64;
    const coords = { latitude: center[1], longitude: center[0] };
    const km = radiusInMeters / 1000;
    const ret = [];

    const distanceX = km / (111.32 * Math.cos(coords.latitude * Math.PI / 180));
    const distanceY = km / 110.574;

    for (let i = 0; i < points; i++) {
      const theta = (i / points) * 2 * Math.PI;
      const x = distanceX * Math.cos(theta);
      const y = distanceY * Math.sin(theta);
      ret.push([coords.longitude + x, coords.latitude + y]);
    }
    ret.push(ret[0]);

    return {
      type: 'Feature',
      geometry: {
        type: 'Polygon',
        coordinates: [ret]
      }
    };
  }

  document.getElementById('saveFenceData').addEventListener('click', function () {
    const fenceName = document.getElementById('name').value;
    const lat = document.getElementById('lat').value;
    const lon = document.getElementById('lon').value;
    const radius = document.getElementById('radiusSlider').value;

    const payload = {
      name: fenceName,
      latitude: parseFloat(lat),
      longitude: parseFloat(lon),
      radius: parseInt(radius)
    };

    const url = isCreate
      ? `https://group-api-b4pm.onrender.com/api/group/${groupUUID}/fences/create`
      : `https://group-api-b4pm.onrender.com/api/group/${groupUUID}/fences/${fenceUUID}/update`;

    const method = isCreate ? 'POST' : 'PATCH';

    fetch(url, {
      method,
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify(payload)
    })
      .then(response => {
        if (!response.ok) throw new Error(`Error: ${response.status}`);
        return response.json();
      })
      .then(data => {
        window.parent.postMessage({
          action: 'geofenceSaved',
          fenceUUID: isCreate ? data.uuid : fenceUUID,
          latitude: parseFloat(lat),
          longitude: parseFloat(lon),
          radius: parseInt(radius),
          name: fenceName,
          closeModal: true
        }, '*');
      })
      .catch(error => {
        console.error('Error saving fence data:', error);
        alert(`Error saving fence data: ${error.message}`);
      });
  });

  document.getElementById('deleteFenceData').addEventListener('click', function () {
    if (!confirm('Are you sure you want to delete this geofence?')) return;

    const url = `https://group-api-b4pm.onrender.com/api/group/${groupUUID}/fences/${fenceUUID}/delete`;

    fetch(url, {
      method: 'DELETE',
      headers: {
        Authorization: `Bearer ${token}`
      }
    })
      .then(response => {
        if (!response.ok) throw new Error(`Error: ${response.status}`);
      })
      .then(() => {
        window.parent.postMessage({
          action: 'geofenceDeleted',
          fenceUUID,
          closeModal: true
        }, '*');
        window.close();
      })
      .catch(error => {
        console.error('Error deleting geofence:', error);
        alert(`Error deleting geofence: ${error.message}`);
      });
  });
</script>


</body>

</html>